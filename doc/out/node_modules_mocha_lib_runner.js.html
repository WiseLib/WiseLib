<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: node_modules/mocha/lib/runner.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: node_modules/mocha/lib/runner.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
/**
 * Module dependencies.
 */

var EventEmitter = require('events').EventEmitter
  , debug = require('debug')('mocha:runner')
  , Test = require('./test')
  , utils = require('./utils')
  , filter = utils.filter
  , keys = utils.keys;

/**
 * Non-enumerable globals.
 */

var globals = [
  'setTimeout',
  'clearTimeout',
  'setInterval',
  'clearInterval',
  'XMLHttpRequest',
  'Date'
];

/**
 * Expose `Runner`.
 */

module.exports = Runner;

/**
 * Initialize a `Runner` for the given `suite`.
 *
 * Events:
 *
 *   - `start`  execution started
 *   - `end`  execution complete
 *   - `suite`  (suite) test suite execution started
 *   - `suite end`  (suite) all tests (and sub-suites) have finished
 *   - `test`  (test) test execution started
 *   - `test end`  (test) test completed
 *   - `hook`  (hook) hook execution started
 *   - `hook end`  (hook) hook complete
 *   - `pass`  (test) test passed
 *   - `fail`  (test, err) test failed
 *
 * @api public
 */

function Runner(suite) {
  var self = this;
  this._globals = [];
  this.suite = suite;
  this.total = suite.total();
  this.failures = 0;
  this.on('test end', function(test){ self.checkGlobals(test); });
  this.on('hook end', function(hook){ self.checkGlobals(hook); });
  this.grep(/.*/);
  this.globals(this.globalProps().concat(['errno']));
}

/**
 * Wrapper for setImmediate, process.nextTick, or browser polyfill.
 *
 * @param {Function} fn
 * @api private
 */

Runner.immediately = global.setImmediate || process.nextTick;

/**
 * Inherit from `EventEmitter.prototype`.
 */

Runner.prototype.__proto__ = EventEmitter.prototype;

/**
 * Run tests with full titles matching `re`. Updates runner.total
 * with number of tests matched.
 *
 * @param {RegExp} re
 * @param {Boolean} invert
 * @return {Runner} for chaining
 * @api public
 */

Runner.prototype.grep = function(re, invert){
  debug('grep %s', re);
  this._grep = re;
  this._invert = invert;
  this.total = this.grepTotal(this.suite);
  return this;
};

/**
 * Returns the number of tests matching the grep search for the
 * given suite.
 *
 * @param {Suite} suite
 * @return {Number}
 * @api public
 */

Runner.prototype.grepTotal = function(suite) {
  var self = this;
  var total = 0;

  suite.eachTest(function(test){
    var match = self._grep.test(test.fullTitle());
    if (self._invert) match = !match;
    if (match) total++;
  });

  return total;
};

/**
 * Return a list of global properties.
 *
 * @return {Array}
 * @api private
 */

Runner.prototype.globalProps = function() {
  var props = utils.keys(global);

  // non-enumerables
  for (var i = 0; i &lt; globals.length; ++i) {
    if (~utils.indexOf(props, globals[i])) continue;
    props.push(globals[i]);
  }

  return props;
};

/**
 * Allow the given `arr` of globals.
 *
 * @param {Array} arr
 * @return {Runner} for chaining
 * @api public
 */

Runner.prototype.globals = function(arr){
  if (0 == arguments.length) return this._globals;
  debug('globals %j', arr);
  utils.forEach(arr, function(arr){
    this._globals.push(arr);
  }, this);
  return this;
};

/**
 * Check for global variable leaks.
 *
 * @api private
 */

Runner.prototype.checkGlobals = function(test){
  if (this.ignoreLeaks) return;
  var ok = this._globals;
  var globals = this.globalProps();
  var isNode = process.kill;
  var leaks;

  // check length - 2 ('errno' and 'location' globals)
  if (isNode &amp;&amp; 1 == ok.length - globals.length) return
  else if (2 == ok.length - globals.length) return;

  leaks = filterLeaks(ok, globals);
  this._globals = this._globals.concat(leaks);

  if (leaks.length > 1) {
    this.fail(test, new Error('global leaks detected: ' + leaks.join(', ') + ''));
  } else if (leaks.length) {
    this.fail(test, new Error('global leak detected: ' + leaks[0]));
  }
};

/**
 * Fail the given `test`.
 *
 * @param {Test} test
 * @param {Error} err
 * @api private
 */

Runner.prototype.fail = function(test, err){
  ++this.failures;
  test.state = 'failed';

  if ('string' == typeof err) {
    err = new Error('the string "' + err + '" was thrown, throw an Error :)');
  }

  this.emit('fail', test, err);
};

/**
 * Fail the given `hook` with `err`.
 *
 * Hook failures (currently) hard-end due
 * to that fact that a failing hook will
 * surely cause subsequent tests to fail,
 * causing jumbled reporting.
 *
 * @param {Hook} hook
 * @param {Error} err
 * @api private
 */

Runner.prototype.failHook = function(hook, err){
  this.fail(hook, err);
  this.emit('end');
};

/**
 * Run hook `name` callbacks and then invoke `fn()`.
 *
 * @param {String} name
 * @param {Function} function
 * @api private
 */

Runner.prototype.hook = function(name, fn){
  var suite = this.suite
    , hooks = suite['_' + name]
    , self = this
    , timer;

  function next(i) {
    var hook = hooks[i];
    if (!hook) return fn();
    self.currentRunnable = hook;

    self.emit('hook', hook);

    hook.on('error', function(err){
      self.failHook(hook, err);
    });

    hook.run(function(err){
      hook.removeAllListeners('error');
      var testError = hook.error();
      if (testError) self.fail(self.test, testError);
      if (err) return self.failHook(hook, err);
      self.emit('hook end', hook);
      next(++i);
    });
  }

  Runner.immediately(function(){
    next(0);
  });
};

/**
 * Run hook `name` for the given array of `suites`
 * in order, and callback `fn(err)`.
 *
 * @param {String} name
 * @param {Array} suites
 * @param {Function} fn
 * @api private
 */

Runner.prototype.hooks = function(name, suites, fn){
  var self = this
    , orig = this.suite;

  function next(suite) {
    self.suite = suite;

    if (!suite) {
      self.suite = orig;
      return fn();
    }

    self.hook(name, function(err){
      if (err) {
        self.suite = orig;
        return fn(err);
      }

      next(suites.pop());
    });
  }

  next(suites.pop());
};

/**
 * Run hooks from the top level down.
 *
 * @param {String} name
 * @param {Function} fn
 * @api private
 */

Runner.prototype.hookUp = function(name, fn){
  var suites = [this.suite].concat(this.parents()).reverse();
  this.hooks(name, suites, fn);
};

/**
 * Run hooks from the bottom up.
 *
 * @param {String} name
 * @param {Function} fn
 * @api private
 */

Runner.prototype.hookDown = function(name, fn){
  var suites = [this.suite].concat(this.parents());
  this.hooks(name, suites, fn);
};

/**
 * Return an array of parent Suites from
 * closest to furthest.
 *
 * @return {Array}
 * @api private
 */

Runner.prototype.parents = function(){
  var suite = this.suite
    , suites = [];
  while (suite = suite.parent) suites.push(suite);
  return suites;
};

/**
 * Run the current test and callback `fn(err)`.
 *
 * @param {Function} fn
 * @api private
 */

Runner.prototype.runTest = function(fn){
  var test = this.test
    , self = this;

  if (this.asyncOnly) test.asyncOnly = true;

  try {
    test.on('error', function(err){
      self.fail(test, err);
    });
    test.run(fn);
  } catch (err) {
    fn(err);
  }
};

/**
 * Run tests in the given `suite` and invoke
 * the callback `fn()` when complete.
 *
 * @param {Suite} suite
 * @param {Function} fn
 * @api private
 */

Runner.prototype.runTests = function(suite, fn){
  var self = this
    , tests = suite.tests.slice()
    , test;

  function next(err) {
    // if we bail after first err
    if (self.failures &amp;&amp; suite._bail) return fn();

    // next test
    test = tests.shift();

    // all done
    if (!test) return fn();

    // grep
    var match = self._grep.test(test.fullTitle());
    if (self._invert) match = !match;
    if (!match) return next();

    // pending
    if (test.pending) {
      self.emit('pending', test);
      self.emit('test end', test);
      return next();
    }

    // execute test and hook(s)
    self.emit('test', self.test = test);
    self.hookDown('beforeEach', function(){
      self.currentRunnable = self.test;
      self.runTest(function(err){
        test = self.test;

        if (err) {
          self.fail(test, err);
          self.emit('test end', test);
          return self.hookUp('afterEach', next);
        }

        test.state = 'passed';
        self.emit('pass', test);
        self.emit('test end', test);
        self.hookUp('afterEach', next);
      });
    });
  }

  this.next = next;
  next();
};

/**
 * Run the given `suite` and invoke the
 * callback `fn()` when complete.
 *
 * @param {Suite} suite
 * @param {Function} fn
 * @api private
 */

Runner.prototype.runSuite = function(suite, fn){
  var total = this.grepTotal(suite)
    , self = this
    , i = 0;

  debug('run suite %s', suite.fullTitle());

  if (!total) return fn();

  this.emit('suite', this.suite = suite);

  function next() {
    var curr = suite.suites[i++];
    if (!curr) return done();
    self.runSuite(curr, next);
  }

  function done() {
    self.suite = suite;
    self.hook('afterAll', function(){
      self.emit('suite end', suite);
      fn();
    });
  }

  this.hook('beforeAll', function(){
    self.runTests(suite, next);
  });
};

/**
 * Handle uncaught exceptions.
 *
 * @param {Error} err
 * @api private
 */

Runner.prototype.uncaught = function(err){
  debug('uncaught exception %s', err.message);
  var runnable = this.currentRunnable;
  if (!runnable || 'failed' == runnable.state) return;
  runnable.clearTimeout();
  err.uncaught = true;
  this.fail(runnable, err);

  // recover from test
  if ('test' == runnable.type) {
    this.emit('test end', runnable);
    this.hookUp('afterEach', this.next);
    return;
  }

  // bail on hooks
  this.emit('end');
};

/**
 * Run the root suite and invoke `fn(failures)`
 * on completion.
 *
 * @param {Function} fn
 * @return {Runner} for chaining
 * @api public
 */

Runner.prototype.run = function(fn){
  var self = this
    , fn = fn || function(){};

  function uncaught(err){
    self.uncaught(err);
  }

  debug('start');

  // callback
  this.on('end', function(){
    debug('end');
    process.removeListener('uncaughtException', uncaught);
    fn(self.failures);
  });

  // run suites
  this.emit('start');
  this.runSuite(this.suite, function(){
    debug('finished running');
    self.emit('end');
  });

  // uncaught exception
  process.on('uncaughtException', uncaught);

  return this;
};

/**
 * Filter leaks with the given globals flagged as `ok`.
 *
 * @param {Array} ok
 * @param {Array} globals
 * @return {Array}
 * @api private
 */

function filterLeaks(ok, globals) {
  return filter(globals, function(key){
    // Firefox and Chrome exposes iframes as index inside the window object
    if (/^d+/.test(key)) return false;
    var matched = filter(ok, function(ok){
      if (~ok.indexOf('*')) return 0 == key.indexOf(ok.split('*')[0]);
      // Opera and IE expose global variables for HTML element IDs (issue #243)
      if (/^mocha-/.test(key)) return true;
      return key == ok;
    });
    return matched.length == 0 &amp;&amp; (!global.navigator || 'onerror' !== key);
  });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="server.html">server</a></li></ul><h3>Global</h3><ul><li><a href="global.html"></a></li><li><a href="global.html#__express">__express</a></li><li><a href="global.html#a">a</a></li><li><a href="global.html#above">above</a></li><li><a href="global.html#addChainableMethod">addChainableMethod</a></li><li><a href="global.html#addMethod">addMethod</a></li><li><a href="global.html#addProperty">addProperty</a></li><li><a href="global.html#arguments">arguments</a></li><li><a href="global.html#assert">assert</a></li><li><a href="global.html#Attrs">Attrs</a></li><li><a href="global.html#attrs">attrs</a></li><li><a href="global.html#awesome">awesome</a></li><li><a href="global.html#Base">Base</a></li><li><a href="global.html#below">below</a></li><li><a href="global.html#Block">Block</a></li><li><a href="global.html#BlockComment">BlockComment</a></li><li><a href="global.html#cache">cache</a></li><li><a href="global.html#camelcase">camelcase</a></li><li><a href="global.html#Case">Case</a></li><li><a href="global.html#cdata">cdata</a></li><li><a href="global.html#clean">clean</a></li><li><a href="global.html#closeTo">closeTo</a></li><li><a href="global.html#Code">Code</a></li><li><a href="global.html#color">color</a></li><li><a href="global.html#colorLines">colorLines</a></li><li><a href="global.html#colors">colors</a></li><li><a href="global.html#Command">Command</a></li><li><a href="global.html#Comment">Comment</a></li><li><a href="global.html#compile">compile</a></li><li><a href="global.html#Compiler">Compiler</a></li><li><a href="global.html#Context">Context</a></li><li><a href="global.html#coverage">coverage</a></li><li><a href="global.html#coverageClass">coverageClass</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#cursor">cursor</a></li><li><a href="global.html#Date">Date</a></li><li><a href="global.html#deep">deep</a></li><li><a href="global.html#deepEqual">deepEqual</a></li><li><a href="global.html#deepProperty">deepProperty</a></li><li><a href="global.html#deepPropertyNotVal">deepPropertyNotVal</a></li><li><a href="global.html#deepPropertyVal">deepPropertyVal</a></li><li><a href="global.html#Doc">Doc</a></li><li><a href="global.html#Doctype">Doctype</a></li><li><a href="global.html#doctypes">doctypes</a></li><li><a href="global.html#doesNotThrow">doesNotThrow</a></li><li><a href="global.html#Dot">Dot</a></li><li><a href="global.html#Each">Each</a></li><li><a href="global.html#empty">empty</a></li><li><a href="global.html#eql">eql</a></li><li><a href="global.html#equal">equal</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#errorDiff">errorDiff</a></li><li><a href="global.html#escape">escape</a></li><li><a href="global.html#escapeRegexp">escapeRegexp</a></li><li><a href="global.html#EventEmitter">EventEmitter</a></li><li><a href="global.html#exec">exec</a></li><li><a href="global.html#exist">exist</a></li><li><a href="global.html#fail">fail</a></li><li><a href="global.html#false">false</a></li><li><a href="global.html#files">files</a></li><li><a href="global.html#Filter">Filter</a></li><li><a href="global.html#filter">filter</a></li><li><a href="global.html#filterLeaks">filterLeaks</a></li><li><a href="global.html#filters">filters</a></li><li><a href="global.html#flag">flag</a></li><li><a href="global.html#forEach">forEach</a></li><li><a href="global.html#format">format</a></li><li><a href="global.html#fragment">fragment</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#getAllFlags">getAllFlags</a></li><li><a href="global.html#getEnumerableProperties">getEnumerableProperties</a></li><li><a href="global.html#getMessage">getMessage</a></li><li><a href="global.html#getPathValue">getPathValue</a></li><li><a href="global.html#getProperties">getProperties</a></li><li><a href="global.html#getType">getType</a></li><li><a href="global.html#globals">globals</a></li><li><a href="global.html#growl">growl</a></li><li><a href="global.html#hideSuitesWithout">hideSuitesWithout</a></li><li><a href="global.html#highlight">highlight</a></li><li><a href="global.html#highlightTags">highlightTags</a></li><li><a href="global.html#Hook">Hook</a></li><li><a href="global.html#HTML">HTML</a></li><li><a href="global.html#HTMLCov">HTMLCov</a></li><li><a href="global.html#ignore">ignore</a></li><li><a href="global.html#ignored">ignored</a></li><li><a href="global.html#image">image</a></li><li><a href="global.html#include">include</a></li><li><a href="global.html#includeMembers">includeMembers</a></li><li><a href="global.html#indexOf">indexOf</a></li><li><a href="global.html#inspect">inspect</a></li><li><a href="global.html#instanceOf">instanceOf</a></li><li><a href="global.html#instanceof">instanceof</a></li><li><a href="global.html#interpolate">interpolate</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isatty">isatty</a></li><li><a href="global.html#isBoolean">isBoolean</a></li><li><a href="global.html#isConstant">isConstant</a></li><li><a href="global.html#isDefined">isDefined</a></li><li><a href="global.html#isFalse">isFalse</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isNotArray">isNotArray</a></li><li><a href="global.html#isNotBoolean">isNotBoolean</a></li><li><a href="global.html#isNotFunction">isNotFunction</a></li><li><a href="global.html#isNotNull">isNotNull</a></li><li><a href="global.html#isNotNumber">isNotNumber</a></li><li><a href="global.html#isNotObject">isNotObject</a></li><li><a href="global.html#isNotString">isNotString</a></li><li><a href="global.html#isNull">isNull</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isTrue">isTrue</a></li><li><a href="global.html#isUndefined">isUndefined</a></li><li><a href="global.html#itself">itself</a></li><li><a href="global.html#JSONCov">JSONCov</a></li><li><a href="global.html#JSONReporter">JSONReporter</a></li><li><a href="global.html#keys">keys</a></li><li><a href="global.html#Landing">Landing</a></li><li><a href="global.html#language%2520chains">language chains</a></li><li><a href="global.html#least">least</a></li><li><a href="global.html#length">length</a></li><li><a href="global.html#lengthOf">lengthOf</a></li><li><a href="global.html#Lexer">Lexer</a></li><li><a href="global.html#Library">Library</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#List">List</a></li><li><a href="global.html#Literal">Literal</a></li><li><a href="global.html#map">map</a></li><li><a href="global.html#Markdown">Markdown</a></li><li><a href="global.html#match">match</a></li><li><a href="global.html#members">members</a></li><li><a href="global.html#merge">merge</a></li><li><a href="global.html#Min">Min</a></li><li><a href="global.html#Mixin">Mixin</a></li><li><a href="global.html#Mocha">Mocha</a></li><li><a href="global.html#most">most</a></li><li><a href="global.html#Node">Node</a></li><li><a href="global.html#nodes">nodes</a></li><li><a href="global.html#not">not</a></li><li><a href="global.html#notDeepEqual">notDeepEqual</a></li><li><a href="global.html#notDeepProperty">notDeepProperty</a></li><li><a href="global.html#notEqual">notEqual</a></li><li><a href="global.html#notInclude">notInclude</a></li><li><a href="global.html#notInstanceOf">notInstanceOf</a></li><li><a href="global.html#notMatch">notMatch</a></li><li><a href="global.html#notOk">notOk</a></li><li><a href="global.html#notProperty">notProperty</a></li><li><a href="global.html#notStrictEqual">notStrictEqual</a></li><li><a href="global.html#notTypeOf">notTypeOf</a></li><li><a href="global.html#null">null</a></li><li><a href="global.html#nulls">nulls</a></li><li><a href="global.html#NyanCat">NyanCat</a></li><li><a href="global.html#objDisplay">objDisplay</a></li><li><a href="global.html#ok">ok</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#operator">operator</a></li><li><a href="global.html#Option">Option</a></li><li><a href="global.html#outputHelpIfNecessary">outputHelpIfNecessary</a></li><li><a href="global.html#overwriteMethod">overwriteMethod</a></li><li><a href="global.html#overwriteProperty">overwriteProperty</a></li><li><a href="global.html#ownProperty">ownProperty</a></li><li><a href="global.html#pad">pad</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#parseBool">parseBool</a></li><li><a href="global.html#parseQuery">parseQuery</a></li><li><a href="global.html#Parser">Parser</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#Progress">Progress</a></li><li><a href="global.html#property">property</a></li><li><a href="global.html#propertyNotVal">propertyNotVal</a></li><li><a href="global.html#propertyVal">propertyVal</a></li><li><a href="global.html#reduce">reduce</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#renderFile">renderFile</a></li><li><a href="global.html#respondTo">respondTo</a></li><li><a href="global.html#rethrow">rethrow</a></li><li><a href="global.html#Runnable">Runnable</a></li><li><a href="global.html#Runner">Runner</a></li><li><a href="global.html#runtime">runtime</a></li><li><a href="global.html#s">s</a></li><li><a href="global.html#sameMembers">sameMembers</a></li><li><a href="global.html#satisfy">satisfy</a></li><li><a href="global.html#selfClosing">selfClosing</a></li><li><a href="global.html#slug">slug</a></li><li><a href="global.html#Spec">Spec</a></li><li><a href="global.html#statsTemplate">statsTemplate</a></li><li><a href="global.html#strictEqual">strictEqual</a></li><li><a href="global.html#string">string</a></li><li><a href="global.html#Suite">Suite</a></li><li><a href="global.html#symbols">symbols</a></li><li><a href="global.html#tag">tag</a></li><li><a href="global.html#Tag">Tag</a></li><li><a href="global.html#TAP">TAP</a></li><li><a href="global.html#Teamcity">Teamcity</a></li><li><a href="global.html#test">test</a></li><li><a href="global.html#Test">Test</a></li><li><a href="global.html#text">text</a></li><li><a href="global.html#Text">Text</a></li><li><a href="global.html#textOnly">textOnly</a></li><li><a href="global.html#throw">throw</a></li><li><a href="global.html#throws">throws</a></li><li><a href="global.html#title">title</a></li><li><a href="global.html#toString">toString</a></li><li><a href="global.html#trim">trim</a></li><li><a href="global.html#true">true</a></li><li><a href="global.html#tty">tty</a></li><li><a href="global.html#type">type</a></li><li><a href="global.html#typeOf">typeOf</a></li><li><a href="global.html#undefined">undefined</a></li><li><a href="global.html#unhide">unhide</a></li><li><a href="global.html#use">use</a></li><li><a href="global.html#useColors">useColors</a></li><li><a href="global.html#utils">utils</a></li><li><a href="global.html#version">version</a></li><li><a href="global.html#watch">watch</a></li><li><a href="global.html#window">window</a></li><li><a href="global.html#within">within</a></li><li><a href="global.html#write">write</a></li><li><a href="global.html#XUnit">XUnit</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha10</a> on Wed Oct 29 2014 12:23:10 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
